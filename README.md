# ✌️又活一天

> **版本**: 1.7.8  
> **适用框架**: AstrBot  
> **核心功能**: 独居/独行安全监控 + 自动报警系统

## 📖 简介

这是一个用于监控用户活跃状态的安全辅助插件。如果用户在设定时间内未在群内或私聊中发言，插件将自动触发分级预警机制，通过 **QQ 群艾特**、**QQ 私聊** 以及 **邮件 (SMTP)** 向用户本人及预设的紧急联系人发送警报。

## ✨ 核心特性

*   **双阶段报警机制**：
    *   **一阶段 (预警)**：仅提醒用户本人（QQ私聊/群艾特/邮件），提示报平安。
    *   **二阶段 (紧急)**：联系紧急联系人（QQ私聊/群艾特）并发送紧急邮件。
*   **全通道通知**：支持 QQ 消息与 Email 同步发送，确保消息必达。
*   **智能邮件系统**：
    *   支持 SSL (465) 及普通端口 (25/80) 自动切换。
    *   兼容 Python 3.10+ SSL 上下文。
    *   支持用户绑定个人邮箱，未绑定自动回退至“紧急联系人QQ邮箱”。
*   **高度自定义**：用户可自定义失联阈值（支持小数，如 0.5 天）、预警话术和报警话术。
*   **高性能架构**：
    *   使用 `asyncio` 异步 I/O 处理文件读写与邮件发送，**绝不阻塞** 机器人主线程。
    *   内存缓存机制，毫秒级响应。
    *   数据持久化符合 AstrBot `StarTools` 规范。

---

## ⚙️ 安装与配置

### 1. 插件安装
将插件文件夹放入 `AstrBot/data/plugins/` 目录下，重启 AstrBot。

### 2. 全局配置 (SMTP 设置)
在 AstrBot 管理后台 -> 插件配置 -> `astrbot_plugin_safety` 中配置邮件服务。

| 配置项 | 说明 | 默认值 / 示例 |
| :--- | :--- | :--- |
| `check_interval` | 后台巡查频率 (秒) | `3600` (1小时) |
| `smtp_host` | SMTP 服务器地址 | `smtpdm.aliyun.com` (阿里云推送)<br>`smtp.qq.com` (QQ邮箱) |
| `smtp_port` | 端口 (SSL推荐465) | `465` (SSL) 或 `80`/`25` |
| `smtp_user` | 发件人邮箱账号 | `robot@yourdomain.com` |
| `smtp_pass` | **授权码/SMTP密码** | ⚠️ **注意：不是登录密码！** |
| `default_warn_msg` | 全局默认预警话术 | ⚠️ [安全提醒] 你已24小时没冒泡了... |
| `default_emerg_msg` | 全局默认报警话术 | 🚨 [紧急求助] 用户 {uid} 已失联... |

> **⚠️ 关于阿里云邮件推送 (Direct Mail) 的特别说明：**
> *   Host 请填：`smtpdm.aliyun.com`
> *   密码请填：**控制台设置的 SMTP 密码**（非阿里云登录密码）。
> *   如果 465 端口发送失败，尝试改成 80 端口。

---

## 💻 指令列表

### 👤 用户指令

| 指令 | 参数 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| `/注册又活一天` | 无 | **核心指令**。注册监控或手动打卡重置计时器。 | `/注册又活一天` |
| `/配置紧急联系人` | `[QQ号]` | 设置你的紧急联系人 QQ。 | `/配置紧急联系人 123456` |
| `/绑定邮箱` | `[邮箱]` | 设置接收通知的邮箱 (推荐)。 | `/绑定邮箱 me@example.com` |
| `/设置失联时间` | `[天数]` | 设置多久不说话算失联 (支持小数)。 | `/设置失联时间 0.5` (12小时) |
| `/设置一阶段` | `[内容]` | 自定义发给自己的预警话术。 | `/设置一阶段 别睡了快起来` |
| `/设置二阶段` | `[内容]` | 自定义发给联系人的报警话术。 | `/设置二阶段 救命我出事了` |

### 🛡️ 管理员指令
> 仅限 AstrBot 全局配置中 `admins_id` 列表内的用户使用。

| 指令 | 参数 | 说明 |
| :--- | :--- | :--- |
| `/安全监控列表` | 无 | 查看当前所有受保护用户的状态、失联时长、阈值等。 |
| `/发送测试` | `[QQ号](可选)` | 强制触发一次**全通道报警测试** (邮件+私聊+群聊)。<br>不填参数默认测试自己。 |
| `/重载安全配置` | 无 | 手动修改 JSON 数据文件后，用此指令热重载，无需重启。 |

---

## 🔄 运行逻辑图解

```mermaid
graph TD
    A[用户发言] --> B(更新最后活跃时间)
    B --> C{定时巡查任务}
    
    C --> D{当前失联时长 > 用户设定阈值?}
    D -- 否 --> E[无操作]
    D -- 是 --> F{已发送过报警?}
    
    F -- 否 --> G[触发报警流程]
    
    G --> H[阶段1: 超过24h但未达阈值]
    H --> I[私聊/群@ 用户本人]
    
    G --> J[阶段2: 超过设定阈值 (紧急)]
    J --> K[发送邮件 (绑定邮箱 > 联系人QQ邮箱)]
    J --> L[私聊用户本人 (兜底通知)]
    J --> M[联系紧急联系人 (群@ + 私聊)]
```

---

## ❓ 常见问题 (FAQ)

**Q1: 为什么时间到了没有报警？**
*   检查 `check_interval` (巡查频率)。如果设置为 3600 秒，那么误差最大可能有 1 小时。建议设置为 300 (5分钟)。
*   确保 Bot 处于连接状态。
*   检查是否发送了 `/注册又活一天` 开启监控。

**Q2: 邮件发送失败，报错 `Authentication failure` (526/535)？**
*   **账号错误**：`smtp_user` 必须是完整的邮箱地址（如 `xxx@qq.com`）。
*   **密码错误**：`smtp_pass` **绝对不能**填网页登录密码。
    *   QQ邮箱：去设置里生成 **授权码**。
    *   阿里云推送：去控制台发信地址处设置 **SMTP 密码**。

**Q3: 如何手动修改用户数据？**
*   数据文件位于：`data/plugin_data/astrbot_plugin_safety/users.json`。
*   修改保存后，在群里发送 `/重载安全配置` 即可生效。